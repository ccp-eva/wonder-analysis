library(stuart)
library(lavaan)
library(reshape2)
library(parallel)

setwd("~/Dropbox/Projekte/Research/Manuel_Bohn")
df<-read.csv("wonder_irt_data.csv")
names(df)
# long to wide
df_wide<-dcast(df, subjID +sex ~ word, value.var = "score")
names(df_wide) <- c("id", "sex", paste0("y", 1:270))
View(df_wide)

load("short_scale.RData")

fs<-list(f=names(df_wide)[c(3:272)])
tmp <- df_wide[, 3:272] |> lapply(as.ordered) |> as.data.frame()

irt_25 <- gene(tmp, fs, 25, item.invariance = 'ess.equivalent', cores=10)
irt_50 <- gene(tmp, fs, 50,item.invariance = 'ess.equivalent', cores=10 )
irt_75 <- gene(tmp, fs, 75,item.invariance = 'ess.equivalent' , cores=10)
irt_100 <- gene(tmp, fs, 100,item.invariance = 'ess.equivalent' , cores=10)
irt_125 <- gene(tmp, fs, 125,item.invariance = 'ess.equivalent' , cores=10)

summary(irt_25$final, fit = TRUE, std = TRUE, rsquare=T)



summary(irt_25)
summary(irt_50)
summary(irt_75)
summary(irt_100)
summary(irt_125)

plot(irt_25)
plot(irt_50)
plot(irt_75)
plot(irt_100)
plot(irt_125)

rel_m25<-summary(irt_25)$Results$crel
rel_m50<-summary(irt_50)$Results$crel
rel_m75<-summary(irt_75)$Results$crel
rel_m100<-summary(irt_100)$Results$crel
rel_m125<-summary(irt_125)$Results$crel


# > summary(irt_25)
# Warning: This is a beta-build of stuart. Please report any bugs you encounter.
# 
# SUMMARY OF ANALYSIS:
#   
#   Analysis Type: gene 
# Estimation Software: lavaan 
# Models Estimated: 21120 
# Replications of final solution: 683 
# Maximum number of generations exceeded. 
# Time Required: 735.251 seconds
# 
# Optimization History:
#   run ind pheromone       rmsea       srmr      crel    chisq  df       pvalue
# 1   1  1.645057 0.043681495 0.10885417 0.9569417 955.0909 299 0.000000e+00
# 1  10  1.701798 0.041552477 0.09365217 0.9661952 892.6943 299 0.000000e+00
# 1  11  1.807402 0.036339585 0.09254689 0.9655378 753.0764 299 0.000000e+00
# 1  17  1.825391 0.035000721 0.09537958 0.9586787 720.2336 299 0.000000e+00
# 1  22  1.878449 0.033242202 0.07888576 0.9596084 678.9694 299 0.000000e+00
# 2  38  1.908918 0.034160475 0.07238589 0.9661058 700.2517 299 0.000000e+00
# 4   3  1.916793 0.028216465 0.09121160 0.9669827 572.7627 299 0.000000e+00
# 4   7  1.944752 0.027391450 0.07888248 0.9599851 556.9877 299 0.000000e+00
# 4  39  1.971035 0.031646130 0.06938355 0.9598155 643.3581 299 0.000000e+00
# 5  19  1.984487 0.029688252 0.07039140 0.9634182 602.0667 299 0.000000e+00
# 6   5  1.998547 0.028658918 0.07002574 0.9628029 581.4155 299 0.000000e+00
# 7   4  2.021205 0.030384252 0.06691840 0.9669818 616.4433 299 0.000000e+00
# 7  36  2.026106 0.031426403 0.06570567 0.9656051 638.5927 299 0.000000e+00
# 7  42  2.026195 0.027552299 0.06850083 0.9622457 560.0266 299 0.000000e+00
# 8  19  2.036232 0.027208886 0.06791065 0.9614578 553.5602 299 0.000000e+00
# 8  21  2.055954 0.029002500 0.06556004 0.9668459 588.2277 299 0.000000e+00
# 10  38  2.056681 0.028640099 0.06574836 0.9670122 581.0448 299 0.000000e+00
# 11  32  2.063896 0.026426568 0.06639022 0.9620801 539.1323 299 5.551115e-16
# 11  54  2.074515 0.030248524 0.06361837 0.9658760 613.6135 299 0.000000e+00
# 12  16  2.089400 0.027705520 0.06418454 0.9644472 562.9378 299 0.000000e+00
# 13   5  2.109886 0.024066112 0.06447778 0.9619175 498.1503 299 3.776202e-12
# 13  31  2.122067 0.025800871 0.06312722 0.9620952 527.8958 299 6.661338e-15
# 13  61  2.132414 0.023263537 0.06341336 0.9611180 485.0889 299 5.206346e-11
# 14   2  2.134756 0.028126462 0.06150054 0.9637906 571.0190 299 0.000000e+00
# 14  15  2.156482 0.026332115 0.06123362 0.9665745 537.4188 299 7.771561e-16
# 15   7  2.198056 0.025541813 0.05952357 0.9665294 523.3223 299 1.831868e-14
# 16  23  2.200592 0.022129084 0.06025556 0.9629378 467.3821 299 1.544255e-09
# 17  10  2.209390 0.023731834 0.05954127 0.9669310 492.6563 299 1.152678e-11
# 19  19  2.212728 0.023046753 0.05948983 0.9636108 481.6369 299 1.023851e-10
# 19  41  2.229214 0.022216269 0.05893004 0.9635579 468.7115 299 1.205597e-09
# 24  18  2.262802 0.023540267 0.05725049 0.9675354 489.5425 299 2.152600e-11
# 24  30  2.292013 0.021010638 0.05650885 0.9658245 450.7915 299 3.072117e-08
# 27   5  2.306978 0.020199395 0.05602107 0.9656345 439.2962 299 2.180965e-07
# 31   6  2.311652 0.020447447 0.05579954 0.9659703 442.7630 299 1.219745e-07
# 32  31  2.313884 0.019610890 0.05582280 0.9654983 431.2402 299 8.132984e-07
# 32  32  2.330840 0.019429011 0.05517846 0.9661931 428.7987 299 1.200347e-06
# 39  46  2.366813 0.016280147 0.05408706 0.9658028 390.1351 299 3.012385e-04
# 43  17  2.396109 0.013923568 0.05309726 0.9647692 365.6607 299 5.040746e-03
# 50  56  2.418552 0.012961619 0.05228877 0.9647115 356.7680 299 1.215602e-02
# 55  50  2.431849 0.012856975 0.05179689 0.9651441 355.8390 299 1.326579e-02
# 56   3  2.434571 0.012477252 0.05171176 0.9651794 352.5312 299 1.797718e-02
# 58   2  2.442076 0.012381559 0.05143851 0.9655383 351.7132 299 1.934670e-02
# 62  11  2.466969 0.008401006 0.05062556 0.9655966 323.2679 299 1.601532e-01
# 96   6  2.486071 0.009632626 0.04987962 0.9657110 330.9050 299 9.887167e-02
# 101  58  2.495865 0.009400252 0.04951971 0.9658448 329.3842 299 1.093880e-01
# 103  18  2.497865 0.011922539 0.04936497 0.9659669 347.8772 299 2.704748e-02
# 112  61  2.499533 0.013174937 0.04925465 0.9664360 358.6851 299 1.012256e-02
# 113  28  2.499728 0.013006182 0.04924973 0.9661007 357.1659 299 1.170640e-02
# 115  28  2.509944 0.010541263 0.04895220 0.9655643 337.2080 299 6.332645e-02
# 121  19  2.521464 0.011814969 0.04848067 0.9660347 346.9992 299 2.914060e-02
# 133  16  2.541414 0.011179314 0.04774910 0.9660778 341.9734 299 4.395766e-02
# 134  34  2.556999 0.012433027 0.04711315 0.9665707 352.1524 299 1.860053e-02
# 149  26  2.569810 0.011966925 0.04664765 0.9669672 348.2418 299 2.621689e-02
# 155   7  2.575373 0.012282709 0.04641588 0.9667618 350.8749 299 2.084370e-02
# 162  35  2.581400 0.011878047 0.04619680 0.9666145 347.5131 299 2.789936e-02
# 166  30  2.611985 0.009340066 0.04509459 0.9673397 328.9964 299 1.121995e-01
# 170  64  2.614632 0.009199881 0.04499092 0.9672103 328.1027 299 1.188824e-01
# 174  25  2.643319 0.010913532 0.04378427 0.9674169 339.9543 299 5.146281e-02
# 183  15  2.650593 0.011017569 0.04348197 0.9674628 340.7389 299 4.843013e-02
# 187   4  2.665124 0.012316950 0.04283268 0.9681322 351.1645 299 2.031552e-02
# 188  27  2.679608 0.010528318 0.04228613 0.9678617 337.1142 299 6.376758e-02
# 199  37  2.686651 0.009345469 0.04202892 0.9682938 329.0311 299 1.119456e-01
# 220  48  2.703580 0.008227200 0.04131646 0.9683032 322.2741 299 1.697352e-01
# 227  32  2.713826 0.008550844 0.04084371 0.9680565 324.1413 299 1.520448e-01
# 238  49  2.719626 0.007967395 0.04060223 0.9684575 320.8274 299 1.843655e-01
# 244  37  2.719719 0.011548030 0.04048546 0.9689087 344.8548 299 3.484083e-02
# 245  29  2.730084 0.006044327 0.04015871 0.9684813 311.5622 299 2.967209e-01
# 259  26  2.730512 0.007994547 0.04009849 0.9684765 320.9764 299 1.828211e-01
# 276  45  2.748703 0.010015964 0.03916731 0.9684267 333.4949 299 8.275914e-02
# 281  34  2.757561 0.009936809 0.03873247 0.9683832 332.9518 299 8.595591e-02
# 298  35  2.761888 0.008893729 0.03855169 0.9683882 326.1980 299 1.340963e-01
# 307  42  2.762308 0.007019131 0.03857859 0.9683186 315.9409 299 2.397098e-01
# 311  38  2.763348 0.005970272 0.03853999 0.9679830 311.2562 299 3.009464e-01
# 
# Constructed Subtests:
#   f: y7 y11 y15 y23 y25 y33 y35 y51 y78 y89 y92 y104 y106 y110 y122 y128 y140 y145 y154 y196 y202 y209 y213 y224 y261


#####
#####


rel25<-rel_m25[length(rel_m25)]
rel50<-rel_m50[length(rel_m50)]
rel75<-rel_m75[length(rel_m75)]
rel100<-rel_m100[length(rel_m100)]
rel125<-rel_m125[length(rel_m125)]

rel<-data.frame(cbind(rel25,rel50, rel75, rel100, rel125))
names(rel) <- c("m25","m50", "m75", "m100", "m125")
rownames(rel) <- c("rel")

fit_m25<-summary(m_25$final, fit = TRUE, std = TRUE, rsquare=T)$fit[c("chisq", "df", "cfi", "rmsea", "srmr", "aic", "bic", "bic2")]
fit_m50<-summary(m_50$final, fit = TRUE, std = TRUE, rsquare=T)$fit[c("chisq", "df", "cfi", "rmsea", "srmr", "aic", "bic", "bic2")]
fit_m75<-summary(m_75$final, fit = TRUE, std = TRUE, rsquare=T)$fit[c("chisq", "df", "cfi", "rmsea", "srmr", "aic", "bic", "bic2")]
fit_m100<-summary(m_100$final, fit = TRUE, std = TRUE, rsquare=T)$fit[c("chisq", "df", "cfi", "rmsea", "srmr", "aic", "bic", "bic2")]
fit_m125<-summary(m_125$final, fit = TRUE, std = TRUE, rsquare=T)$fit[c("chisq", "df", "cfi", "rmsea", "srmr", "aic", "bic", "bic2")]

fit<-data.frame(cbind(fit_m25,fit_m50, fit_m75, fit_m100, fit_m125))
names(fit) <- c("m25","m50", "m75", "m100", "m125")

fit[nrow(fit) + 1,] <- rel
round(fit,2)

save(fit, file="fit.rda")

par_m25<-summary(m_25$final, fit = TRUE, std = TRUE, rsquare=T)
par_m50<-summary(m_50$final, fit = TRUE, std = TRUE, rsquare=T)
par_m75<-summary(m_75$final, fit = TRUE, std = TRUE, rsquare=T)
par_m100<-summary(m_100$final, fit = TRUE, std = TRUE, rsquare=T)
par_m125<-summary(m_125$final, fit = TRUE, std = TRUE, rsquare=T)


par<-list(list(par_m25,par_m50, par_m75, par_m100, par_m125))
str(par)

res_m25<-summary(m_25)
res_m50<-summary(m_50)
res_m75<-summary(m_75)
res_m100<-summary(m_100)
res_m125<-summary(m_125)
res<-list(res_m25,res_m50, res_m75, res_m100, res_m125)

save(res, file="res.rda")
save.image("short_scale.RData")


m_50_p <- gene(df_wide, fs,50,item.invariance = 'ess.parallel', cores=10 )
m_75_p <- gene(df_wide, fs,75,item.invariance = 'ess.parallel' , cores=10)

summary(m_50_p$final, fit.measure=T, standardized=T, rsquare=T)
summary(m_50_p)
plot(m_50_p)

# Constructed Subtests:
#   f: y5 y7 y11 y15 y25 y27 y28 y33 y35 y37 y38 y47 
#  y52 y62 y63 y64 y65 y77 y84 y87 y89 y104 y107 y116 
#  y120 y121 y122 y124 y136 y145 y147 y156 y170 y177 
#  y178 y182 y201 y202 y203 y204 y209 y213 y224 y227 
#  y233 y236 y237 y256 y261 y265

# Constructed Subtests:
#   f: y7 y9 y11 y25 y28 y38 y45 y47 y51 y52 y59 y62 
# y64 y65 y77 y84 y87 y89 y104 y106 y107 y110 y120 y121 
# y122 y124 y128 y139 y145 y148 y150 y154 y157 y168 y170 
# y171 y182 y184 y200 y201 y202 y203 y204 y208 y209 y223 
# y224 y237 y256 y265

summary(m_75_p$final, fit.measure=T, standardized=T, rsquare=T)
plot(m_75_p)


