---
title: "oREV item selection and analysis"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
#library(ggpubr)
library(ggthemes)
library(tidybayes)
library(brms)
library(rstan)
library(loo)
library(coda)
library(testing)
#library(geomtextpath)
library(ggridges)
library(lavaan)
#library(ggbreak)

estimate_mode <- function(s) {
  d <- density(s)
  return(d$x[which.max(d$y)])
}

hdi_upper<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","upper"])
}

hdi_lower<- function(s){
  m <- HPDinterval(mcmc(s))
  return(m["var1","lower"])
}

func <- function(x){
  abs(1-x)
}
```

```{r}
subjects <- readRDS("../saves/subjects.rds")

data <- read_csv("../data/wonder_data.csv")%>%
  filter(subjID %in% subjects)%>%
  mutate(age_group = factor(substr(age, 1,1)))

irt_dat <- data%>%
  select(subjID, word, score, sex, aoa_rating_german)#%>%
  #filter(word %in% fit_selected_items)%>%
  #mutate(subjID = paste0("id", as.numeric(as.factor(subjID))))

#write_csv(irt_dat, "../data/wonder_irt_data.csv")

aoa <- data%>%distinct(word, .keep_all = T)%>%select(word, aoa_rating_german)

full <- data%>%
  group_by(subjID)%>%
  summarise(mean_full = mean(score))

n_distinct(data$subjID)
```

# Models

## Rasch Model

```{r}
prior_1pl <- 
  prior("normal(0, 1)", class = "sd", group = "subjID") + 
  prior("normal(0, 3)", class = "sd", group = "word")
```


### Model

```{r}
# irt1 <- brm(
#   data = irt_dat,
#   family = bernoulli(),
#   score ~ 1 + (1 | word) + (1 | subjID),
#   prior = prior_1pl,
#   control = list(adapt_delta = 0.95, max_treedepth = 20),
#   cores = 6,
#   chains = 6,
#   iter = 6000,
#   threads = threading(8), #to speed things up, comment out if not on a cluster
#   backend = "cmdstanr" #to speed things up, comment out if not on a cluster
# )
# 
# saveRDS(irt1, "../saves/irt1.rds")
# 
# irt1 <- add_criterion(
#   irt1,
#   criterion = c("loo","waic"),
#   cores = 1,
#   ndraws = 2000
# )
# 
# saveRDS(irt1, "../saves/irt1.rds")

irt1 <- readRDS("../saves/irt1.rds")
```

### Extract fit indices

```{r}
rasch_fit_draws <- irt_dat%>%
  add_epred_draws(irt1, re_formula = ~(1 | word) + (1 | subjID), ndraws = 1000)
  
rasch_fit <- rasch_fit_draws%>%
  mutate(zvi = (score - .epred)/(.epred*(1-.epred))^0.5)%>%
  group_by(word,aoa_rating_german, .draw)%>%
  summarise(outfit = sum(zvi^2)/length(unique(subjID)),
            infit = (sum(zvi^2*(.epred*(1-.epred)))/sum(.epred*(1-.epred))))

rasch_fit_mode <- rasch_fit%>%
  pivot_longer(names_to = "fit_index", values_to = "value", cols = c(outfit, infit))%>%
  group_by(word, aoa_rating_german, fit_index)%>%
  summarise(mode = estimate_mode(value),
            lci = hdi_lower(value),
            uci = hdi_upper(value))

saveRDS(rasch_fit_mode, "../saves/rasch_fit_mode.rds")

rasch_fit_mode <- readRDS("../saves/rasch_fit_mode.rds")

```


```{r}
rasch_fit_mode%>%
  group_by(fit_index)%>%
  mutate(group = as.factor(as.numeric(cut_number(aoa_rating_german, 6))))%>%
  ggplot(. , aes(y = fct_reorder(word, aoa_rating_german), x = mode, col = fit_index))+
  geom_vline(xintercept = c(0.7, 1.3), lty = 3, alpha = .5)+
  geom_vline(xintercept = c(0.5, 1.5), lty = 2, alpha = .5)+
  geom_vline(xintercept = 1, lty = 1, alpha = .5, col = "darkgreen")+
  geom_pointrange(aes(xmin = lci, xmax = uci))+
  scale_fill_colorblind()+
  scale_color_colorblind(name = "Fit index")+
    labs(x = "Index value", y = "Target word (sorted by rated age of acquisition)")+
  facet_wrap(~group, scales = "free_y", nrow = 2)+
  scale_x_continuous(breaks = c(0,0.5, 07, 1, 1.3, 1.5), labels = c(0,0.5, 07, 1, 1.3, 1.5), limits = c(0,4))+
  theme_bw()+
  theme(legend.position = c(0.95,0.8))
```
```{r}
# remove items that have very poor in and outfit 

fit_selected_items <- rasch_fit_mode%>%ungroup()%>%filter(0.7 < mode & 1.3 > mode)%>%group_by(word)%>%mutate(n = n())%>%filter(n == 2)%>%distinct(word)%>%pull(word)

saveRDS(fit_selected_items, "../saves/fit_selected_items.rds")

fit_selected_items <- readRDS( "../saves/fit_selected_items.rds")

```


```{r}
rasch_fit_mode%>%
  filter(word %in% fit_selected_items)%>%
  group_by(word)%>%
  mutate(n = n())%>%
  filter(n == 2)%>%
  ungroup()%>%
  mutate(group = as.factor(as.numeric(cut_number(aoa_rating_german, 6))))%>%
  ggplot(. , aes(y = fct_reorder(word, aoa_rating_german), x = mode, col = fit_index))+
  geom_vline(xintercept = c(0.7, 1.3), lty = 3, alpha = .5)+
  geom_vline(xintercept = c(0.5, 1.5), lty = 2, alpha = .5)+
  geom_vline(xintercept = 1, lty = 1, alpha = .5, col = "darkgreen")+
  geom_pointrange(aes(xmin = lci, xmax = uci))+
  scale_fill_colorblind()+
  scale_color_colorblind(name = "Fit index")+
    labs(x = "Index value", y = "Target word (sorted by rated age of acquisition)")+
  facet_wrap(~group, scales = "free_y", nrow = 2)+
  #scale_x_continuous(breaks = c(0,0.5, 07, 1, 1.3, 1.5), labels = c(0,0.5, 07, 1, 1.3, 1.5), limits = c(0,7))+
  theme_bw()+
  theme(legend.position = c(0.95,0.8))
```

```{r}
ggsave("../graphs/in_outfit_select.png", height = 8, width = 16, scale = 1.5)
```

## 1PL model for selected items

Run script `run1PLmodel_sel_fit.R`

```{r}
irt1_fit_sel <- readRDS("../saves/irt1_fit_sel.rds")
loo(irt1_fit_sel)

irt1_fit_sel2 <- irt1_fit_sel%>%add_criterion(criterion = c("loo"), overwrite = T)

irt1_fit_sel$criteria$loo = NULL

loo(irt1_fit_sel2)
```

```{r}
rasch_fit_draws_fit_sel <- irt_dat%>%
  filter(word %in% fit_selected_items)%>%
  add_epred_draws(irt1_fit_sel, re_formula = ~(1 | word) + (1 | subjID), ndraws = 1000)

rasch_fit_fit_sel <- rasch_fit_draws_fit_sel%>%
  mutate(zvi = (score - .epred)/(.epred*(1-.epred))^0.5)%>%
  group_by(word,aoa_rating_german, .draw)%>%
  summarise(outfit = sum(zvi^2)/length(unique(subjID)),
            infit = (sum(zvi^2*(.epred*(1-.epred)))/sum(.epred*(1-.epred))))

rasch_fit_mode_fit_sel <- rasch_fit_fit_sel%>%
  pivot_longer(names_to = "fit_index", values_to = "value", cols = c(outfit, infit))%>%
  group_by(word, aoa_rating_german, fit_index)%>%
  summarise(mode = estimate_mode(value),
            lci = hdi_lower(value),
            uci = hdi_upper(value))

saveRDS(rasch_fit_mode_fit_sel, "../saves/rasch_fit_mode_fit_sel.rds")

rasch_fit_mode_fit_sel <- readRDS("../saves/rasch_fit_mode_fit_sel.rds")



rasch_fit_fit_sel <- rasch_fit_draws_fit_sel%>%
  mutate(res = (score - .epred))%>%
  summarise(rsmea = mean(res))
```


```{r}
rasch_fit_mode_fit_sel%>%
  select(word, fit_index, mode)%>%
  rename(sel_fit_mode = mode)%>%
  left_join(rasch_fit_mode)%>%
  group_by(fit_index)%>%
  summarise(cor = cor(sel_fit_mode, mode))
```

### RMSEA
```{r}
ndata <- irt_dat%>%
  filter(word %in% fit_selected_items)%>%
  distinct(subjID, word)

pred_dat <- fitted(irt1_fit_sel, newdata = ndata, re_formula = ~(1 | word) + (1 | subjID))%>%
  as_tibble() %>%
  bind_cols(ndata)

residual_dat <- pred_dat%>%
  mutate(residual = (score - .epred))

residual_dat%>%
  ungroup()%>%
  summarise(mean_residual = mean(residual))

n_distinct(irt_dat$subjID)
```


### ICC

```{r}
icc1PL <- posterior_samples(irt1_fit_sel)%>% 
  select(b_Intercept, starts_with("r_word"))%>%
  mutate(iter = 1:n()) %>% 
  pivot_longer(starts_with("r_word"), names_to = "item", values_to = "xi") %>%
  mutate(item = str_extract(string = item, pattern = "(?<=\\[).*(?=,Intercept\\])"))%>%
  expand(nesting(iter, b_Intercept, item, xi),
         theta = seq(from = -6, to = 6, length.out = 100)) %>% 
  mutate(p = inv_logit_scaled(b_Intercept + xi + theta)) %>% 
  group_by(theta, item) %>% 
  summarise(p = mean(p))%>%
  left_join(aoa%>%rename(item = word))
```

```{r}
icc1PL %>% 
  ggplot(aes(x = theta, y = p,group = item, col = aoa_rating_german)) +
  geom_line() +
  #facet_wrap(~group)+
  #guides(col = F)+
  scale_color_viridis_c(name = "AoA") +
  labs(title = "ICCs for the 1PL",
       x = expression(theta~('ability on the logit scale')),
       y = expression(italic(p)(y==1))) +
  theme_minimal()
```


## 2PL Model for selected items

Run script `run2PLmodel_sel_fit.R`

```{r}
irt2PL_fit_sel <- readRDS("../saves/irt2PL_fit_sel.rds")
```
### Easiness and discrimination

```{r}
coef_2PL <- coef(irt2PL_fit_sel)

eta <- coef_2PL$word[, , "eta_Intercept"] %>%
	as_tibble(rownames = "item")

alpha <- coef_2PL$word[, , "logalpha_Intercept"] %>%
	exp() %>%
	as_tibble(rownames = "item")

params <- bind_rows(eta, alpha, .id = "nlpar") %>%
	select(-Est.Error) %>%
	mutate(nlpar = factor(nlpar, labels = c("Easiness", "Discrimination")))%>%
  left_join(aoa%>%rename(item = word))

ggplot(params,aes(reorder(item, -aoa_rating_german), Estimate, ymin = Q2.5, ymax = Q97.5)) +
	facet_wrap("nlpar", scales = "free_x") +
	geom_pointrange() +
	coord_flip() +
	labs(x = "Item")+
  theme_minimal()
```


### ICC

```{r}
icc2PL <- posterior_samples(irt2PL_fit_sel)%>% 
  select(b_eta_Intercept, b_logalpha_Intercept, starts_with("r_word"))%>%
  mutate(iter = 1:n()) %>% 
  pivot_longer(starts_with("r_word")) %>%
  mutate(item      = str_extract(name, pattern = "(?<=\\[).*(?=,Intercept\\])"),
         parameter = ifelse(str_detect(name, "eta"), "xi", "logalpha"))%>%
  select(-name) %>% 
  pivot_wider(names_from = parameter, values_from = value)%>% 
  expand(nesting(iter, b_eta_Intercept, b_logalpha_Intercept, item, xi, logalpha),
         theta = seq(from = -6, to = 6, length.out = 100)) %>% 
  # note the difference in the equation
  mutate(p = inv_logit_scaled(exp(b_logalpha_Intercept + logalpha) * (b_eta_Intercept + theta + xi))) %>% 
  group_by(theta, item) %>% 
  summarise(p = mean(p))%>%
  left_join(aoa%>%rename(item = word))

```

```{r}
icc2PL %>% 
  ggplot(aes(x = theta, y = p,group = item, col = aoa_rating_german)) +
  geom_line() +
  #facet_wrap(~group)+
  #guides(col = F)+
  scale_color_viridis_c(name = "AoA") +
  labs(title = "ICCs for the 2PL",
       x = expression(theta~('ability on the logit scale')),
       y = expression(italic(p)(y==1))) +
  theme_minimal()
```

## Compare ICCs

```{r}
bind_rows(
icc1PL%>%mutate(model = "1PL"),
icc2PL%>%mutate(model = "2PL"),
)%>% 
  ggplot(aes(x = theta, y = p,group = model, col = model)) +
  geom_line() +
  facet_wrap(~item)+
  #guides(col = F)+
  scale_color_colorblind(name = "Model") +
  labs(x = expression(theta~('ability on the logit scale')),
       y = expression(italic(p)(y==1))) +
  theme_void()
```



## Compare models

```{r}
loo_compare(irt1_fit_sel, irt2PL_fit_sel)%>%as_tibble(rownames = "model")
```

## Modindices

```{r}
all_items <- irt_dat%>%
  filter(word %in% fit_selected_items)%>%
  distinct(word)%>%
  pull(word)

irt_all <- irt_dat%>%
  filter(word %in% fit_selected_items)%>%
  select(-aoa_rating_german)%>%
  pivot_wider(names_from = word, values_from = score)%>%
  select( -subjID, -sex)

modelAllx <- paste(paste0("1*",all_items, "+"), collapse = " ")

modelAll <- paste0("f =~", substr(modelAllx, 1, nchar(modelAllx)-1))

freqAll <- sem(modelAll, irt_all, ordered =TRUE, parameterization = "theta")

saveRDS(freqAll, "../saves/freqAll.rds")

freqAll <- readRDS("../saves/freqAll.rds")

summary(freqAll, standardized = TRUE)

miAll <- modindices(freqAll)

miAllSel <- miAll%>%
  filter(lhs == "f")
  

saveRDS(miAllSel, "../saves/miAllSel.rds")


```

# Indices

```{r}
mi <- readRDS("../saves/miAllSel.rds")%>%arrange(rhs)
items <-data%>%filter(word %in% fit_selected_items)%>%distinct(word)%>%arrange(word)%>%pull(word)
easiness_1PL_fit_sel <- ranef(irt1_fit_sel)$word%>%as_tibble(rownames = "word")%>%arrange(word) %>%pull(Estimate.Intercept)
infit_fit_sel <- rasch_fit_mode_fit_sel %>% filter(fit_index == "infit")%>%arrange(word)%>% pull(mode)
outfit_fit_sel <- rasch_fit_mode_fit_sel %>% filter(fit_index == "outfit")%>%arrange(word)%>% pull(mode)
disc_2PL_fit_sel <- coef(irt2PL_fit_sel)$word[, , "logalpha_Intercept"] %>% as_tibble(rownames = "word")%>%arrange(word)%>%pull(Estimate)
```




# Item selection

## Simulated annealing algorithm

```{r}
source("../scripts/helper/simulated_annealing.R")
```

### Test run

```{r, message=F, warning=F, comment=F}

sim_rasch_test <- simulated_annealing_rasch(50)

sel_items_rasch_test <- items[unlist(sim_rasch_test$best_subset) == TRUE]

sub_rasch_test <- data%>%
  filter(word %in% sel_items_rasch_test,
         )%>%
  group_by(age_group,subjID)%>%
  summarise(mean_sub = mean(score))

comp_rasch_test<- full%>%left_join(sub_rasch_test)

ggplot(comp_rasch_test, aes(x = mean_full, y = mean_sub))+
  geom_abline(intercept = 0, slope = 1, lty = 2, alpha = .75)+
  geom_jitter(pch = 1, alpha = .75, height = 0.01, width = 0.01)+
  stat_cor()+
  facet_wrap(~age_group)+
  ylim(0,1.02)+
  xlim(0,1.02)+
  theme_few()

```

## Determine size

### Person parameters

```{r}
# full_model_ci_range <- ranef(irt1_fit_sel)$subjID%>%as_tibble(rownames = "subjID")%>%mutate(size = 270)
# 
# saveRDS(full_model_ci_range, "../saves/full_model_ci_range.rds")

ci_ranges <- #readRDS("../saves/determine_size.rds")%>%
  #mutate(type = "1PL params only")%>%
  bind_rows(readRDS("../saves/determine_size_w2PL.rds"))%>%
  #bind_rows(readRDS("../saves/full_model_ci_range.rds")%>%mutate(iter = 1, type = "1PL params only"))%>%
  bind_rows(readRDS("../saves/full_model_ci_range.rds")%>%mutate(iter = 1, type = "with 2PL disc params"))%>%
  group_by(size,iter, type)%>%
  mutate(ci_range = Q97.5.Intercept - Q2.5.Intercept)%>%
  summarise(mean_ci_range = mean(ci_range))
```

```{r}
ggplot(ci_ranges, aes(x = size, y = mean_ci_range, col = factor(iter)))+
  geom_point()+
  geom_line()+
  labs(x = "No of items", y = "Mean CrI range of person parameters")+
  scale_color_colorblind(name = "Run")+
  #facet_grid(iter~type)+
  #ylim(0.5,2)+
  scale_x_continuous(breaks = c(50,75,100,125,150,175,200,225,250,270),labels = c(50,75,100,125,150,175,200,225,250,"all items"))+
  theme_bw()
```

```{r}
ggsave("../graphs/determine_size.png", height = 4, width = 6)
```


```{r}
readRDS("../saves/determine_size.rds")%>%
  bind_rows(readRDS("../saves/full_model_ci_range.rds"))%>%
  group_by(size)%>%
  mutate(ci_range = Q97.5.Intercept - Q2.5.Intercept)%>%
  ggplot( aes(x = size, y = ci_range))+
  geom_point( alpha = .01)+
  geom_line(aes(group = subjID), alpha = .01)+
  labs(x = "No of items", y = "Mean CrI range of person parameters")+
  #ylim(0.5,2)+
  theme_bw()
```

### Items

```{r}
sel_items <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 150)%>%
  distinct(iter,items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(150)%>%
  select(items)%>%
  rename(word = items)

sel_items%>%
  left_join(data%>% distinct(word, word_type))%>%
  group_by(word_type)%>%
  summarise(prop_type = n()/150)

```

```{r}
param_cor <- readRDS("../saves/determine_size.rds")%>%
  mutate(type = "1PL params only")%>%
  bind_rows(readRDS("../saves/determine_size_w2PL.rds"))%>%
  left_join(readRDS("../saves/full_model_ci_range.rds")%>%rename(full_est = Estimate.Intercept)%>%select(subjID, full_est), by = "subjID")%>%
  group_by(size,iter, type)%>%
  summarise(cor = cor(Estimate.Intercept, full_est))
```

```{r}
ggplot(param_cor, aes(x = size, y = cor, col = factor(iter)))+
  geom_point(aes(pch = type))+
  geom_line(aes(lty = type))+
  labs(x = "No of items", y = "Correlation with person parameters based on all items")+
  ylim(0.9,1)+
  scale_color_colorblind(name = "Run")+
  theme_bw()
```

```{r}
sel_it_comp_tobi_50 <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 50)%>%
  select(items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(50)%>%
  pull(items)

itme_list_50 <- read_csv("../data/wonder_irt_data.csv")%>%
  distinct(word)%>%
  mutate(no = row_number())%>%
  filter(word %in% sel_it_comp_tobi_50)

tobi_items_50 <- c(1, 6, 9, 18, 21, 22, 23, 52, 64, 65, 66, 71, 77, 78, 87, 92, 98, 99, 100, 103, 114, 118, 119, 123, 131, 134, 150, 152, 153, 166, 170, 174, 176, 186, 188, 189, 195, 198, 199, 205, 208, 210, 217, 218, 235, 248, 249, 251, 253, 264)

sum(itme_list_50$no %in% tobi_items_50)
```

```{r}
sel_it_comp_tobi_75 <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 75)%>%
  select(items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(75)%>%
  pull(items)

item_list_75 <- read_csv("../data/wonder_irt_data.csv")%>%
  distinct(word)%>%
  mutate(no = row_number())%>%
  filter(word %in% sel_it_comp_tobi_100)

tobi_items_75 <- c(1,6,11,15,16,21,22,23,24,31,33,36,44,54,62,65,71,74,78,80,81,82,91,92,96,97,99,106,108,110,111,117,120,121,122,123,124,128,130,132,140,145,149,151,152,158,166,168,170,178,182,183,186,188,189,193,196,200,201,204,205,209,210,217,218,219,221,229,236,244,249,250,251,261,265)

sum(item_list_75$no %in% tobi_items_75)
```

```{r}
sel_it_comp_tobi_100 <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 100)%>%
  select(items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(100)%>%
  pull(items)

item_list_100 <- read_csv("../data/wonder_irt_data.csv")%>%
  distinct(word)%>%
  mutate(no = row_number())%>%
  filter(word %in% sel_it_comp_tobi_100)

tobi_items_100 <- c(1,6,7,11,15,18,19,21,22,23,24,25,27,31,36,37,38,41,42,44,45,47,48,51,54,65,67,69,70,71,73,74,75,77,78,80,81,82,85,86,89,91,92,96,99,106,108,111,113,115,117,120,121,122,127,130,132,137,140,145,146,149,151,152,157,160,166,167,168,169,170,182,183,185,186,188,189,193,201,203,204,205,209,210,211,213,217,219,221,223,229,235,236,240,244,249,251,257,265,266)

tobi_items_100_words <- read_csv("../data/wonder_irt_data.csv")%>%
  distinct(word)%>%
  mutate(no = row_number())%>%
  filter(no %in% tobi_items_100)

sum(item_list_100$no %in% tobi_items_100)
```


```{r}
sel_it_comp_tobi_75 <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 75)%>%
  select(items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(75)%>%
  pull(items)

itme_list_75 <- read_csv("../data/wonder_irt_data.csv")%>%
  distinct(word)%>%
  mutate(no = row_number())%>%
  filter(word %in% sel_it_comp_tobi_75)

tobi_items_75 <- c(4, 6, 7, 9, 11, 21, 22, 23, 34, 38, 45, 47, 51, 52, 59, 62, 65, 66, 70, 71, 77, 78, 84, 87, 91, 92, 98, 99, 100, 103, 114, 117, 118, 119, 120, 121, 128, 131, 137, 145, 148, 150, 151, 153, 157, 160, 163, 166, 168, 170, 171, 172, 176, 182, 183, 184, 188, 189, 195, 196, 198, 199, 201, 202, 205, 208, 218, 223, 236, 238, 244, 248, 251, 261, 265)

sum(itme_list_75$no %in% tobi_items_75)
```


```{r}
rasch_fit_mode_fit_sel

dif_1Pl <- ranef(irt1_fit_sel)$word%>%as_tibble(rownames = "item")

sel_comp <- bind_rows(rasch_fit_mode_fit_sel%>%select(-aoa_rating_german)%>%rename(item =word),
dif_1Pl%>%
  select(-Est.Error.Intercept)%>%
  mutate(fit_index = "easiness")%>%
  rename(mode = Estimate.Intercept, 
         lci = Q2.5.Intercept, 
         uci = Q97.5.Intercept)
)%>%left_join(rasch_fit_mode_fit_sel%>%select(word, aoa_rating_german)%>%rename(item =word))


sel_comp_plot <- sel_comp%>%
  mutate(selection1 = ifelse(item %in% item_list_100$word, "annealing", "none"))%>%
  mutate(selection2 = ifelse(item %in% tobi_items_100_words$word, "genes", "none"))%>%
  mutate(selection3 = ifelse(item %in% item_list_100$word & item %in% tobi_items_100_words$word, "both", "none"))%>%
  mutate(selection = ifelse(selection3 == "both", "both","none"),
         selection = ifelse(selection != "both" & selection1 == "annealing", "annealing",selection),
         selection = ifelse(selection != "both" & selection2 == "genes", "genes",selection))


sel_comp_plot%>%
  #group_by(fit_index)%>%
  #mutate(group = as.factor(as.numeric(cut_number(aoa_rating_german, 3))))%>%
  ggplot(. , aes(y = reorder(item, mode), x = mode, col = selection))+
  #geom_vline(xintercept = c(0.7, 1.3), lty = 3, alpha = .5)+
  #geom_vline(xintercept = c(0.5, 1.5), lty = 2, alpha = .5)+
  #geom_vline(xintercept = 1, lty = 1, alpha = .5, col = "darkgreen")+
  geom_pointrange(aes(xmin = lci, xmax = uci))+
  scale_fill_colorblind()+
  scale_color_colorblind(name = "Selection")+
  labs(x = "Index value", y = "Target word (sorted by rated age of acquisition)")+
  facet_grid(~fit_index, scales = "free_x")+
  #scale_x_continuous(breaks = c(0,0.5, 07, 1, 1.3, 1.5), labels = c(0,0.5, 07, 1, 1.3, 1.5), limits = c(0,4))+
  theme_bw()#+
  theme(legend.position = c(0.95,0.8))
```

```{r}
ggsave("../graphs/selection_comp.pdf", height = 18, width = 10, scale = 1.5)
```


### Refit frequentist model for different sizes

#### 75 Items

```{r}
sel_items_75 <- readRDS("../saves/determine_size.rds")%>%
  filter(size == 75)%>%
  select(items)%>%
  unnest()%>%
  group_by(items)%>%
  summarise(n = n())%>%
  arrange(-n)%>%
  head(75)%>%
  pull(items)


irt_75 <- irt_dat%>%
  filter(word %in% sel_items_75)%>%
  select(-aoa_rating_german)%>%
  pivot_wider(names_from = word, values_from = score)%>%
  select( -subjID, -sex)

model75x <- paste(paste0("1*",sel_items_75, "+"), collapse = " ")

model75 <- paste0("f =~", substr(model75x, 1, nchar(model75x)-1))

freq75 <- sem(model75, irt_75, ordered =TRUE, parameterization = "theta")
# 
# saveRDS(freq75, "../saves/freq75.rds")
# 
# #summary(freq75, fit = TRUE, std = TRUE, rsquare=T)

freq75 <- readRDS("../saves/freq75.rds")

fit_in_75 <- fitMeasures(freq75)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 75)



```

#### 100 items

```{r}
# sel_items_100 <- readRDS("../saves/determine_size.rds")%>%
#   filter(size == 100)%>%
#   select(items)%>%
#   unnest()%>%
#   group_by(items)%>%
#   summarise(n = n())%>%
#   arrange(-n)%>%
#   head(100)%>%
#   pull(items)
# 
# irt_100 <- irt_dat%>%
#   filter(word %in% sel_items_100)%>%
#   select(-aoa_rating_german)%>%
#   pivot_wider(names_from = word, values_from = score)%>%
#   select( -subjID, -sex)
# 
# model100x <- paste(paste0("1*",sel_items_100, "+"), collapse = " ")
# 
# model100 <- paste0("f =~", substr(model100x, 1, nchar(model100x)-1))
# 
# freq100 <- sem(model100, irt_100, ordered =TRUE, parameterization = "theta")
# 
# saveRDS(freq100, "../saves/freq100.rds")
# 
# #summary(freq100, fit = TRUE, std = TRUE, rsquare=T)

freq100 <- readRDS("../saves/freq100.rds")

fit_in_100 <- fitMeasures(freq100)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 100)

```

#### 125 items

```{r}
# sel_items_125 <- readRDS("../saves/determine_size.rds")%>%
#   filter(size == 125)%>%
#   select(items)%>%
#   unnest()%>%
#   group_by(items)%>%
#   summarise(n = n())%>%
#   arrange(-n)%>%
#   head(125)%>%
#   pull(items)
# 
# irt_125 <- irt_dat%>%
#   filter(word %in% sel_items_125)%>%
#   select(-aoa_rating_german)%>%
#   pivot_wider(names_from = word, values_from = score)%>%
#   select( -subjID, -sex)
# 
# model125x <- paste(paste0("1*",sel_items_125, "+"), collapse = " ")
# 
# model125 <- paste0("f =~", substr(model125x, 1, nchar(model125x)-1))
# 
# freq125 <- sem(model125, irt_125, ordered =TRUE, parameterization = "theta")
# 
# #summary(freq125, fit = TRUE, std = TRUE, rsquare=T)
# 
# saveRDS(freq125, "../saves/freq125.rds")

freq125 <- readRDS("../saves/freq125.rds")

fit_in_125 <- fitMeasures(freq125)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 125)

```
#### 150 items

```{r}
# sel_items_150 <- readRDS("../saves/determine_size.rds")%>%
#   filter(size == 150)%>%
#   select(items)%>%
#   unnest()%>%
#   group_by(items)%>%
#   summarise(n = n())%>%
#   arrange(-n)%>%
#   head(150)%>%
#   pull(items)
# 
# irt_150 <- irt_dat%>%
#   filter(word %in% sel_items_150)%>%
#   select(-aoa_rating_german)%>%
#   pivot_wider(names_from = word, values_from = score)%>%
#   select( -subjID, -sex)
# 
# model150x <- paste(paste0("1*",sel_items_150, "+"), collapse = " ")
# 
# model150 <- paste0("f =~", substr(model150x, 1, nchar(model150x)-1))
# 
# freq150 <- sem(model150, irt_150, ordered =TRUE, parameterization = "theta")
# 
# #summary(freq150, fit = TRUE, std = TRUE, rsquare=T)
# 
# saveRDS(freq150, "../saves/freq150.rds")

freq150 <- readRDS("../saves/freq150.rds")

fit_in_150 <- fitMeasures(freq150)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 150)
```


#### 175 items

```{r}
# sel_items_175 <- readRDS("../saves/determine_size.rds")%>%
#   filter(size == 175)%>%
#   select(items)%>%
#   unnest()%>%
#   group_by(items)%>%
#   summarise(n = n())%>%
#   arrange(-n)%>%
#   head(175)%>%
#   pull(items)
# 
# irt_175 <- irt_dat%>%
#   filter(word %in% sel_items_175)%>%
#   select(-aoa_rating_german)%>%
#   pivot_wider(names_from = word, values_from = score)%>%
#   select( -subjID, -sex)
# 
# model175x <- paste(paste0("1*",sel_items_175, "+"), collapse = " ")
# 
# model175 <- paste0("f =~", substr(model175x, 1, nchar(model175x)-1))
# 
# freq175 <- sem(model175, irt_175, ordered =TRUE, parameterization = "theta")
# 
# saveRDS(freq175, "../saves/freq175.rds")

freq175 <- readRDS("../saves/freq175.rds")

#summary(freq175, fit = TRUE, std = TRUE, rsquare=T)

fit_in_175 <- fitMeasures(freq175)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 175)
```

#### 200 items

```{r}
# sel_items_200 <- readRDS("../saves/determine_size.rds")%>%
#   filter(size == 200)%>%
#   select(items)%>%
#   unnest()%>%
#   group_by(items)%>%
#   summarise(n = n())%>%
#   arrange(-n)%>%
#   head(200)%>%
#   pull(items)
# 
# irt_200 <- irt_dat%>%
#   filter(word %in% sel_items_200)%>%
#   select(-aoa_rating_german)%>%
#   pivot_wider(names_from = word, values_from = score)%>%
#   select( -subjID, -sex)
# 
# model200x <- paste(paste0("1*",sel_items_200, "+"), collapse = " ")
# 
# model200 <- paste0("f =~", substr(model200x, 1, nchar(model200x)-1))
# 
# freq200 <- sem(model200, irt_200, ordered =TRUE, parameterization = "theta")
# 
# saveRDS(freq200, "../saves/freq200.rds")

freq200 <- readRDS("../saves/freq200.rds")

#summary(freq200, fit = TRUE, std = TRUE, rsquare=T)

fit_in_200 <- fitMeasures(freq200)%>%as_tibble(rownames = "index")%>%
  filter(index == "rmsea" | index == "cfi" | index == "srmr")%>%
  mutate(no_items = 200)
```   


#### Plot fit indices

```{r}
fit_in <- bind_rows(
fit_in_75,
fit_in_100,
fit_in_125,
fit_in_150,
fit_in_175,
fit_in_200
)%>%
  mutate(cutoff = ifelse(index == "cfi", 0.95, 0.05))

ggplot(fit_in, aes(x = factor(no_items), y = value, col = index))+
    geom_hline(aes(yintercept = cutoff), lty = 3, alpha = .75)+
    geom_point()+
    geom_line(aes(group = (index)))+
    scale_color_colorblind()+
    scale_y_continuous(limits = c(0,1))+
    scale_y_break(c(0.15, 0.9 ) )+
  labs(x = "No of items", y = "Index value")+
    theme_bw()

```
```{r}
ggsave("../graphs/fit_indices.pdf", width = 8, height = 6, scale = 1.25)
```


## Model comparison

```{r}
readRDS("../saves/model_comparison.rds")
```


## Word type by size

```{r}
type_size <- tibble()

for (j in 3:10) {
  
for (i in c(50,75, 100,125,150,175,200,225,250, 275, 300)) {
  
   sim <- simulated_annealing_rasch(i)
  
   sel <- items[unlist(sim$best_subset) == TRUE]

    type <- data%>%
      distinct(word, word_type)%>%
      filter(word %in% sel)%>%
      group_by(word_type)%>%
      summarise(prop_type = n()/length(sel))%>%
      mutate(size = i, iter = j)
  
  type_size <- bind_rows(type_size, type)
}
  
}


ggplot(type_size, aes(x = size, y = prop_type, col = word_type))+
  geom_point()+
  geom_line(aes(group = interaction(word_type,iter)))+
  scale_color_colorblind()+
  theme_bw()
```






## Extract selected items

```{r}
selected_items <- readRDS("../saves/determine_size_w2PL.rds")%>%
  filter(size == 175)%>%
  select(items, iter)%>%
  distinct(items, iter)%>%
  unnest(items)%>%
  rename(word = items)%>%
  left_join(data%>%distinct(word, word_type))
  
selected_items%>%
  group_by(word,word_type)%>%
  summarise(n = n()/max(iter))%>%
  ggplot(aes(x = reorder(word, -n), y = n, fill = word_type))+
  geom_bar(stat = "identity", col = "black")+
  labs(x = "Item", y = "Proportion selected")+
  #facet_grid(~word_type)+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


rasch_selected_items <- selected_items%>%
  group_by(word,word_type)%>%
  summarise(n = n()/max(iter))%>%
  arrange(-n)%>%
  ungroup()%>%
  head(175)%>%
  select(-n)%>%
  pull(word)

#write_csv(rasch_selected_items,"../data/selected_items.csv")

saveRDS(rasch_selected_items, "../saves/selected_items_rasch.rds")

rasch_selected_items <- readRDS("../saves/selected_items_rasch.rds")
```

# Rasch model with selected items

## Fit model 

```{r}
irt_dat_sel <- irt_dat%>%
  filter(word %in% rasch_selected_items)
```


```{r}
irt1_guess_sel <- brm(
  data = irt_dat_sel,
  family = bernoulli(),
  score ~ 1 + (1| word) + (1 | subjID),
  prior = prior_1pl,
  control = list(adapt_delta = 0.95, max_treedepth = 20),
  cores = 6,
  chains = 6,
  iter = 8000,
  threads = threading(8), #to speed things up, comment out if not on a cluster
  backend = "cmdstanr" #to speed things up, comment out if not on a cluster
)%>%add_criterion(c("loo","waic")) 


saveRDS(irt1_guess_sel, "../saves/irt1_guess_sel.rds")

irt1_guess_sel <- readRDS("../saves/irt1_guess_sel.rds")
```

## ICC

```{r}
icc1_guess_sel <- posterior_samples(irt1_guess_sel)%>% 
  select(b_eta_Intercept, starts_with("r_targetWord"))%>%
  mutate(iter = 1:n()) %>% 
  pivot_longer(starts_with("r_targetWord"), names_to = "item", values_to = "xi") %>%
  mutate(item = str_extract(string = item, pattern = "(?<=\\[).*(?=,Intercept\\])"))%>%
  expand(nesting(iter, b_eta_Intercept, item, xi),
         theta = seq(from = -6, to = 6, length.out = 100)) %>% 
  mutate(p = 0.25 + 0.75*inv_logit_scaled((b_eta_Intercept + theta + xi))) %>%  
  group_by(theta, item) %>% 
  summarise(p = mean(p))%>%
  left_join(aoa%>%rename(item = targetWord))
```

```{r}
icc1_guess_sel %>% 
  ggplot(aes(x = theta, y = p,group = item, col = aoa_german_comb)) +
  geom_line() +
  #geom_textline(aes(label = item)) +
  geom_hline(yintercept = 0.25, lty = 3, alpha = .75)+
  scale_color_viridis_c(name = "AoA") +
  labs(title = "ICCs for the 1PL",
       x = expression(theta~('ability on the logit scale')),
       y = expression(italic(p)(y==1))) +
  ylim(0,1)+
  theme_minimal()
```

```{r}
ggsave("../graphs/ICC_1PL_sel.png", height = 6, width = 10, scale = 1, bg = "white")
```

## Differential Item Functioning

### Sex

```{r}
irt1_dif_sex_sel <-  brm(
  data = irt_dat_sel,
  family = bernoulli(),
  score ~ 1 + (0+ sex | word) + (1 | subjID),
  prior = prior_1pl,
  control = list(adapt_delta = 0.95, max_treedepth = 20),
  cores = 6,
  chains = 6,
  iter = 8000,
  threads = threading(8), #to speed things up, comment out if not on a cluster
  backend = "cmdstanr" #to speed things up, comment out if not on a cluster
)


saveRDS(irt1_dif_sex_sel, "../saves/irt1_dif_sex_sel.rds")

irt1_dif_sex_sel<- readRDS("../saves/irt1_dif_sex_sel.rds")

```


### Comapre models

```{r}
loo_compare(irt1_guess_sel, irt1_guess_dif_order_sel, irt1_guess_dif_sex_sel)%>%as_tibble(rownames = "model")
```

### Visual model inspection

```{r}
dif_sex <- as_draws_df(irt1_dif_sex_sel)%>%
  select(b_Intercept, starts_with("r_word"))%>%
  mutate(iter = 1:n()) %>%
  pivot_longer(starts_with("r_word")) %>%
  mutate(name = str_remove(name, pattern = "r_word"),
         name = str_remove_all(name, pattern = "\\[|\\]"))%>%
  separate(name, into = c("item", "sex"), sep = "\\,")%>%
  mutate(sex = str_remove(sex, pattern = "sex"),
         val =  value)%>%
  group_by(item, sex)%>%
  summarise(mode = estimate_mode(val),
            uci = hdi_upper(val),
            lci = hdi_lower(val))%>%
  left_join(aoa%>%rename(item = word))

saveRDS(dif_sex, "../saves/model_params_irt1_dif_sex.rds")

dif_sex <- readRDS("../saves/model_params_irt1_dif_sex.rds")

ggplot(dif_sex,aes(x = reorder(item, aoa_rating_german))) +
	geom_point(aes(col = sex, y = lci), position = position_dodge(width = .5)) +
  geom_point(aes(col = sex, y = uci), position = position_dodge(width = .5)) +
  geom_linerange(aes(col = sex, ymin = lci + 0.1, ymax = uci-0.1), position = position_dodge(width = .5), alpha = .5) +
	coord_flip() +
  scale_color_colorblind(labels = c("male","female"), name = "Group")+
	labs(x = "Item", y = "Easiness estimate")+
  theme_minimal()
```

```{r}
ggsave("../graphs/dif_ci.png", height = 20, width = 10, scale = 1, bg = "white")
```

```{r}
dif_sex%>%
  pivot_wider(names_from = sex, values_from = c(mode,uci,lci))%>%
  ggplot(., aes(x = mode_f, y = mode_m))+
  geom_abline(intercept = 0, slope = 1, lty = 3, alpha = .75)+
  geom_point(pch = 1, size = 2, stroke  = 1, aes(col = factor(aoa_rating_german)))+
  geom_linerange(aes(ymin = lci_m, ymax = uci_m),  alpha = .25, lty = 1)+
  geom_linerange(aes(xmin = lci_f, xmax = uci_f),  alpha = .25, lty = 1)+
  #geom_text(aes(label = item, x = uci_f +0.2))+
  labs(x = "Group: female", y = "Group: male")+
  scale_color_viridis_d()+
  guides(col = F)+
  coord_fixed()+
  theme_few()
  
```

```{r}
ggsave("../graphs/dif_cor.png", height = 6, width = 6, scale = 1.2)
```

# Reliability

## KR20

```{r}
# full test
rel_dat <- irt_dat%>%
  select(-sex, -aoa_rating_german)%>%
  filter(word %in% readRDS( "../saves/fit_selected_items.rds"))%>%
  group_by(subjID)%>%
  distinct(word, .keep_all = T)%>%
  pivot_wider(names_from = word, values_from = score)%>%
  ungroup()%>%
  select(-subjID)

kr20_rel <- kr20(rel_dat, hit = 1)

kr20_rel

# selected items

rel_dat_sel <- irt_dat%>%
  select(-sex, -aoa_rating_german)%>%
  filter(word %in% readRDS( "../saves/fit_selected_items.rds"))%>%
  group_by(subjID)%>%
  distinct(targetWord, .keep_all = T)%>%
  pivot_wider(names_from = targetWord, values_from = correct)%>%
  ungroup()%>%
  select(-subjID)

kr20_rel_sel <- kr20(rel_dat_sel, hit = 1)

kr20_rel_sel
```

## Andrich Reliability

```{r}
# full task 
pers_params <- ranef(irt1_fit_sel)$subjID%>%as_tibble(rownames = "subjID")


sep_rel <- 1 - 
  (1/length(pers_params$Estimate.Intercept) * sum(pers_params$Est.Error.Intercept^2))/
  (1/(length(pers_params$Estimate.Intercept)-1)*sum((pers_params$Estimate.Intercept - mean(pers_params$Estimate.Intercept))^2))


sep_rel

# selected items only 
pers_params_sel <- ranef(irt1_guess_sel)$subjID%>%as_tibble(rownames = "subjID")


sep_rel_sel <- 1 - 
  (1/length(pers_params_sel$Estimate.eta_Intercept) * sum(pers_params_sel$Est.Error.eta_Intercept^2))/
  (1/(length(pers_params_sel$Estimate.eta_Intercept)-1)*sum((pers_params_sel$Estimate.eta_Intercept - mean(pers_params_sel$Estimate.eta_Intercept))^2))


sep_rel_sel
```


# Selected items compared to random subset

```{r}

new_items <- data%>%filter(source == "new items")%>%distinct(targetWord)%>%pull(targetWord)

cor_random <- tibble()

for (j in 10:20){
  
for (i in 1:100) {
  
   sel <- sample(new_items, j)

   cor <- data%>%
      filter(targetWord %in% sel)%>%
      group_by(subjID)%>%
  summarise(mean_sub = mean(correct))%>%
  right_join(full)%>%
  summarise(cor = cor(mean_sub, mean_full))%>%
  mutate(iter = i, 
         size = j)
  
  cor_random <- bind_rows(cor_random, cor)
}

}
  
saveRDS(cor_random, "../saves/cor_random.rds")

cor_random <- readRDS("../saves/cor_random.rds")

rasch_selected_items
```

```{r}
cor_random%>%
  ggplot(aes(x = cor, y = factor(size)))+
  geom_vline(xintercept = determine_size%>%filter(iter ==1, size == 22)%>%pull(correlation), lty = 3, alpha = .75)+
  stat_binline(alpha = .75) +
  labs(x = "Correlation subtest with full test", y = "No. of newly added items in subset")+
  theme_few()+
  theme(axis.ticks.y = element_blank())
```
```{r}
ggsave("../graphs/rand_sel_cor.png", height = 6, width = 8, scale = 1)
```
